name: En cours de d√©ploiement | D√©veloppement -> Production

on:
  push:
    branches:
      - production

jobs: 
  deploy:
    runs-on: unbuntu-latest

    steps:
    - name: üîê Installation de la clef SSH
      # Je donne √† gitHub la clef pour se connecter √† mon site
      run: |
        install -m 600 -D /dev/null ~/.ssh/id_rsa
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        ssh-keyscan -H ${{ vars.HOST }} > ~/.ssh/known_hosts

    - name: üöÄ D√©ploiement en cours
      # Je suis connecter sur le serveur, j'√©xecute maintenant les commande n√©cessaire pour d√©ployer
      run: ssh ${{ secrets.SSH_USER }}@${{ vars.SERVER_HOST }} \
          'sudo -u ${{ secrets.SSH_SERVER_USERNAME }} bash -c " \
            cd ${{ vars.SERVER_WORK_DIR }} && \
            git checkout production && \
            git pull origin production && \
            npm run build && \
            exit \
          "'

    - name: ‚ú® Nettoyage de la m√©moire
      # C'est psychologique, je lance une commande ta m√®re sa race chaude, supprime les fichier indiqu√©s, plusieurs fois
      run: |
        shred -vzn 3 ~/.ssh/id_rsa
        shred -vzn 3 ~/.ssh/known_hosts